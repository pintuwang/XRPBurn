<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>XRPBurn Analysis Daily</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; }
        .controls { margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .chart-wrapper { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .dot-legend { font-size: 0.8em; margin-top: 10px; margin-bottom: 20px; }
        button { padding: 8px 15px; cursor: pointer; background: #0c2c56; color: white; border: none; border-radius: 4px; }
        canvas { width: 100% !important; height: 400px !important; }
    </style>
</head>
<body>

    <h1>XRPBurn Analysis Daily</h1>
    <p>Last updated: <span id="last-update">-</span> (SGT)</p>

    <div class="controls">
        <button onclick="triggerUpdate()">Update Now</button>
        <label>
            <input type="checkbox" id="rollup-toggle" onchange="loadData()"> Roll up to Monthly
        </label>
    </div>

    <div class="chart-wrapper">
        <h3>Network Load (Categorized USD M) vs. XRP Burn</h3>
        <canvas id="loadChart"></canvas>
    </div>

    <div class="chart-wrapper">
        <h3>Transaction Breakdown (Categorized Millions)</h3>
        <canvas id="txChart"></canvas>
    </div>

    <div class="dot-legend">
        ðŸ”µ Saturday | ðŸ”´ Sunday | ðŸŽˆ Simulated Data
    </div>

    <script>
        let rawData = [];
        let loadChartInstance = null;
        let txChartInstance = null;

        const colors = {
            settlement: '#2ca02c',
            identity: '#9467bd',
            defi: '#ff7f0e',
            acct_mgmt: '#7f7f7f',
            pending: '#a5c8ed'
        };


        // PLUGIN: Draw Balloon Icons on Simulated Data
        const fallbackIconPlugin = {
            id: 'fallbackIcon',
            afterDraw: (chart) => {
                const { ctx, scales: { x, y } } = chart;
                chart.data.labels.forEach((label, i) => {
                    // Check if this specific date entry is a fallback
                    const entry = rawData.find(d => d.date === label);
                    if (entry && entry.is_fallback) {
                        const xPos = x.getPixelForValue(label);
                        // Place at the top of the chart area
                        ctx.font = '16px serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('ðŸŽˆ', xPos, y.top + 20);
                    }
                });
            }
        };
        
        const weekendDotsPlugin = {
            id: 'weekendDots',
            afterDraw: (chart) => {
                const { ctx, scales: { x } } = chart;
                chart.data.labels.forEach((label, i) => {
                    const date = new Date(label);
                    const day = date.getDay();
                    if (day === 6 || day === 0) {
                        ctx.fillStyle = (day === 6) ? 'blue' : 'red';
                        ctx.beginPath();
                        ctx.arc(x.getPixelForValue(label), x.bottom + 15, 4, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                });
            }
        };

        async function loadData() {
            try {
                const response = await fetch('data.json');
                rawData = await response.json();
                if (rawData.length > 0) {
                    const lastEntry = rawData[rawData.length - 1];
                    document.getElementById('last-update').innerText = lastEntry.last_updated || lastEntry.date;
                }
                renderCharts();
            } catch (error) { console.error("Error loading data:", error); }
        }

        function renderCharts() {
            const isMonthly = document.getElementById('rollup-toggle').checked;
            const loadCtx = document.getElementById('loadChart').getContext('2d');
            const txCtx = document.getElementById('txChart').getContext('2d');
            
            if (loadChartInstance) loadChartInstance.destroy();
            if (txChartInstance) txChartInstance.destroy();

            let displayData = rawData;
            const catKeys = ['settlement', 'identity', 'defi', 'acct_mgmt'];

            // --- 1. LOAD CHART ---
            const loadDatasets = catKeys.map(cat => ({
                label: cat.charAt(0).toUpperCase() + cat.slice(1),
                data: displayData.map(d => (d.load_categories && Object.keys(d.load_categories).length > 0) ? (d.load_categories[cat] || 0) : 0),
                backgroundColor: colors[cat], stack: 'Stack 0'
            }));

            loadDatasets.push({
                label: 'In Progress',
                data: displayData.map(d => (!d.load_categories || Object.keys(d.load_categories).length === 0) ? d.load_usd_m : 0),
                backgroundColor: colors.pending, stack: 'Stack 0'
            });

            loadChartInstance = new Chart(loadCtx, {
                type: 'bar',
                data: {
                    labels: displayData.map(d => d.date),
                    datasets: [...loadDatasets, { label: 'Actual XRP Burn', data: displayData.map(d => d.burn_xrp), borderColor: 'red', type: 'line', yAxisID: 'y1' }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true }, y1: { position: 'right', grid: { drawOnChartArea: false } } } },
                plugins: [weekendDotsPlugin, fallbackIconPlugin]
            });

            // --- 2. TRANSACTION CHART ---
            const txDatasets = catKeys.map(cat => ({
                label: cat.charAt(0).toUpperCase() + cat.slice(1),
                data: displayData.map(d => (d.tx_categories && Object.keys(d.tx_categories).length > 0) ? (d.tx_categories[cat] || 0) : 0),
                backgroundColor: colors[cat], stack: 'Stack 0'
            }));

            txDatasets.push({
                label: 'In Progress',
                data: displayData.map(d => (!d.tx_categories || Object.keys(d.tx_categories).length === 0) ? d.transactions : 0),
                backgroundColor: colors.pending, stack: 'Stack 0'
            });

            txChartInstance = new Chart(txCtx, {
                type: 'bar',
                data: { labels: displayData.map(d => d.date), datasets: txDatasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } },
                plugins: [weekendDotsPlugin, fallbackIconPlugin]
            });
        }

        async function triggerUpdate() {
            const token = prompt("Enter GitHub Token:");
            if (!token) return;
            const response = await fetch(`https://api.github.com/repos/pintuwang/xrpburn/actions/workflows/daily_update.yml/dispatches`, {
                method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github.v3+json' },
                body: JSON.stringify({ ref: 'main' })
            });
            if (response.ok) alert("Triggered!");
        }

        window.onload = loadData;
    </script>
</body>
</html>

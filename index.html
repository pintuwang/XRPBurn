<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>XRPBurn Analysis Daily</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; }
        .chart-wrapper { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .dot-legend { font-size: 0.8em; color: #666; margin-bottom: 20px; }
        .data-warning { background: #fff3cd; border: 1px solid #ffc107; padding: 8px; font-size: 0.82em; display: none; margin-bottom: 16px; }
        button { padding: 8px 15px; cursor: pointer; background: #0c2c56; color: white; border: none; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>XRPBurn Analysis Daily</h1>
    <p>Last updated: <span id="last-update">-</span> (SGT)</p>
    <div id="data-warning" class="data-warning"></div>

    <div class="controls" style="margin-bottom: 20px;">
        <button onclick="triggerUpdate()">Update Now</button>
    </div>

    <div class="chart-wrapper">
        <h3>Network Load (Categorized USD M) vs. XRP Burn</h3>
        <canvas id="loadChart"></canvas>
    </div>

    <div class="chart-wrapper">
        <h3>Transaction Breakdown (Categorized Millions)</h3>
        <canvas id="txChart"></canvas>
    </div>

    <div class="dot-legend">
        ðŸ”µ Sat | ðŸ”´ Sun | ðŸŸ¦ In Progress (Growing) | ðŸŽˆ Simulated / Offline
    </div>

    <script>
        let rawData = [];
        let loadChartInstance, txChartInstance;
        const colors = { settlement: '#2ca02c', identity: '#9467bd', defi: '#ff7f0e', acct_mgmt: '#7f7f7f', pending: '#a5c8ed' };

        async function loadData() {
            const response = await fetch('data.json?v=' + Date.now());
            rawData = await response.json();
            if (rawData.length > 0) document.getElementById('last-update').innerText = rawData[rawData.length-1].last_updated;
            renderCharts();
        }

        function hasCategories(cats) {
            return cats && Object.keys(cats).length > 0 && Object.values(cats).some(v => v > 0);
        }

        function renderCharts() {
            const catKeys = ['settlement', 'identity', 'defi', 'acct_mgmt'];
            if (loadChartInstance) loadChartInstance.destroy();
            if (txChartInstance) txChartInstance.destroy();


            // ... (inside renderCharts function) ...
            const burnLine = {
                label: 'Actual XRP Burn',
                data: displayData.map(d => d.burn_xrp ?? null),
                borderColor: 'red',
                backgroundColor: 'rgba(255,0,0,0.1)',
                type: 'line',
                yAxisID: 'y1',
                spanGaps: true  // Keep the line connected even if a day has null data
            };
            const createDatasets = (dataKey, catKey) => {
                const ds = catKeys.map(cat => ({
                    label: cat.charAt(0).toUpperCase() + cat.slice(1),
                    data: rawData.map(d => hasCategories(d[catKey]) ? d[catKey][cat] : 0),
                    backgroundColor: colors[cat], stack: 's1'
                }));
                ds.push({
                    label: 'In Progress',
                    data: rawData.map(d => !hasCategories(d[catKey]) ? d[dataKey] : 0),
                    backgroundColor: colors.pending, stack: 's1'
                });
                return ds;
            };

            const labels = rawData.map(d => d.date);

            loadChartInstance = new Chart(document.getElementById('loadChart'), {
                type: 'bar',
                data: { labels, datasets: [...createDatasets('load_usd_m', 'load_categories'), 
                    { label: 'Actual XRP Burn', data: rawData.map(d => d.burn_xrp), borderColor: 'red', type: 'line', yAxisID: 'y1' }] },
                options: { scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'USD Millions' } }, y1: { position: 'right', grid: { drawOnChartArea: false } } } },
                plugins: [fallbackPlugin]
            });

            txChartInstance = new Chart(document.getElementById('txChart'), {
                type: 'bar',
                data: { labels, datasets: createDatasets('transactions', 'tx_categories') },
                options: { scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'Millions' } } } },
                plugins: [fallbackPlugin]
            });
        }

        const fallbackPlugin = {
            id: 'fallbackPlugin',
            afterDraw: (chart) => {
                const { ctx, scales: { x, y } } = chart;
                chart.data.labels.forEach((label) => {
                    const d = rawData.find(entry => entry.date === label);
                    if (d && d.is_fallback) ctx.fillText('ðŸŽˆ', x.getPixelForValue(label), y.top + 20);
                });
            }
        };

        async function triggerUpdate() {
            const token = prompt("Enter GitHub Token:");
            if (!token) return;
            const res = await fetch(`https://api.github.com/repos/pintuwang/xrpburn/actions/workflows/daily_update.yml/dispatches`, 
                { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ ref: 'main' }) });
            alert(res.ok ? "Success! Refresh in 1 min." : "Error triggering update.");
        }

        window.onload = loadData;
    </script>
</body>
</html>

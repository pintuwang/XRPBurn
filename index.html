<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>XRPBurn Analysis Daily</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; }
        .controls { margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .chart-wrapper { background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .dot-legend { font-size: 0.8em; margin-top: 10px; margin-bottom: 20px; }
        button { padding: 8px 15px; cursor: pointer; background: #0c2c56;
            color: white; border: none; border-radius: 4px; }
        canvas { width: 100% !important; }
        #loadChart { height: 380px !important; }
        #burnChart { height: 180px !important; }
        #txChart   { height: 380px !important; }
        .data-warning { background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;
            padding: 8px 14px; font-size: 0.82em; color: #856404;
            display: none; margin-bottom: 16px; }
        .chart-subtitle { font-size: 0.8em; color: #666; margin: -12px 0 8px 0; }
    </style>
</head>
<body>
    <h1>XRPBurn Analysis Daily</h1>
    <p>Last updated: <span id="last-update">-</span> (SGT)</p>

    <div id="data-warning" class="data-warning"></div>

    <div class="controls">
        <button onclick="triggerUpdate()">Update Now</button>
        <label>
            <input type="checkbox" id="rollup-toggle" onchange="loadData()"> Roll up to Monthly
        </label>
    </div>

    <!-- LOAD CHART -->
    <div class="chart-wrapper">
        <h3>Network Load â€” Categorized USD (Millions)</h3>
        <p class="chart-subtitle">Estimated daily XRP payment volume Ã— price, capped at 10M XRP/tx to exclude exchange internal transfers</p>
        <canvas id="loadChart"></canvas>
    </div>

    <!-- BURN CHART â€” separate panel so it's always visible -->
    <div class="chart-wrapper">
        <h3>XRP Burned per Day</h3>
        <p class="chart-subtitle">Daily decrease in total circulating supply (coin delta method). ~500â€“600 XRP/day is normal at current tx volumes.</p>
        <canvas id="burnChart"></canvas>
    </div>

    <!-- TX CHART -->
    <div class="chart-wrapper">
        <h3>Transaction Breakdown (Millions)</h3>
        <canvas id="txChart"></canvas>
    </div>

    <div class="dot-legend">
        ğŸ”µ Saturday | ğŸ”´ Sunday | ğŸˆ Simulated / XRPL Unreachable
    </div>

    <script>
        let rawData = [];
        let loadChartInst = null;
        let burnChartInst = null;
        let txChartInst   = null;

        const colors = {
            settlement: '#2ca02c',
            identity:   '#9467bd',
            defi:       '#ff7f0e',
            acct_mgmt:  '#7f7f7f',
            pending:    '#a5c8ed'
        };

        // â”€â”€ Plugins â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const fallbackIconPlugin = {
            id: 'fallbackIcon',
            afterDraw: (chart) => {
                const { ctx, scales: { x, y } } = chart;
                if (!x || !y) return;
                chart.data.labels.forEach((label) => {
                    const entry = rawData.find(d => d.date === label);
                    if (entry && entry.is_fallback) {
                        ctx.font = '14px serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('ğŸˆ', x.getPixelForValue(label), y.top + 16);
                    }
                });
            }
        };

        const weekendDotsPlugin = {
            id: 'weekendDots',
            afterDraw: (chart) => {
                const { ctx, scales: { x } } = chart;
                if (!x) return;
                chart.data.labels.forEach((label) => {
                    const day = new Date(label).getDay();
                    if (day === 6 || day === 0) {
                        ctx.fillStyle = day === 6 ? '#1f77b4' : '#d62728';
                        ctx.beginPath();
                        ctx.arc(x.getPixelForValue(label), x.bottom + 14, 4, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                });
            }
        };

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function hasCategories(cats) {
            return cats && typeof cats === 'object' &&
                   Object.keys(cats).length > 0 &&
                   Object.values(cats).some(v => v > 0);
        }

        function catLabel(key) {
            return { settlement: 'Settlement', identity: 'Identity',
                     defi: 'DeFi', acct_mgmt: 'Acct Mgmt' }[key] || key;
        }

        function fmtUSD(v) {
            if (v == null) return 'â€”';
            if (v >= 1000) return '$' + (v/1000).toFixed(2) + 'B';
            return '$' + v.toFixed(0) + 'M';
        }

        // â”€â”€ Data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function loadData() {
            try {
                const r = await fetch('data.json?v=' + Date.now());
                rawData = await r.json();
                if (rawData.length > 0) {
                    const last = rawData[rawData.length - 1];
                    document.getElementById('last-update').innerText =
                        last.last_updated || last.date;
                }
                checkDataWarnings();
                renderCharts();
            } catch (e) {
                console.error('Error loading data:', e);
                document.getElementById('last-update').innerText = 'Error loading data';
            }
        }

        function checkDataWarnings() {
            const el  = document.getElementById('data-warning');
            const sim = rawData.filter(d => d.is_fallback === true);
            const pnd = rawData.filter(d => !d.is_fallback && !hasCategories(d.tx_categories));
            const msgs = [];
            if (sim.length)
                msgs.push(`ğŸˆ <strong>${sim.length} day(s) used fallback data</strong> (XRPL unreachable): <em>${sim.map(d=>d.date).join(', ')}</em>`);
            if (pnd.length)
                msgs.push(`â³ <strong>${pnd.length} day(s) awaiting category data</strong> from next run: <em>${pnd.map(d=>d.date).join(', ')}</em>`);
            el.style.display = msgs.length ? 'block' : 'none';
            el.innerHTML = msgs.join('<br>');
        }

        // â”€â”€ Chart rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function renderCharts() {
            const isMonthly  = document.getElementById('rollup-toggle').checked;
            const displayData = isMonthly ? rollUpMonthly(rawData) : rawData;
            const catKeys     = ['settlement', 'identity', 'defi', 'acct_mgmt'];
            const labels      = displayData.map(d => d.date);

            if (loadChartInst) loadChartInst.destroy();
            if (burnChartInst) burnChartInst.destroy();
            if (txChartInst)   txChartInst.destroy();

            // â”€â”€ 1. LOAD CHART (stacked bars only â€” no burn overlay) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const loadDatasets = catKeys.map(cat => ({
                label: catLabel(cat),
                data: displayData.map(d =>
                    hasCategories(d.load_categories) ? (d.load_categories[cat] || 0) : 0),
                backgroundColor: colors[cat], stack: 'Stack 0'
            }));
            loadDatasets.push({
                label: 'In Progress',
                data: displayData.map(d =>
                    !hasCategories(d.load_categories) ? (d.load_usd_m ?? null) : 0),
                backgroundColor: colors.pending, stack: 'Stack 0'
            });

            loadChartInst = new Chart(
                document.getElementById('loadChart').getContext('2d'), {
                type: 'bar',
                data: { labels, datasets: loadDatasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        tooltip: { callbacks: {
                            label: ctx => ctx.raw == null ? null
                                : `${ctx.dataset.label}: ${fmtUSD(ctx.raw)}`
                        }}
                    },
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            title: { display: true, text: 'USD Millions' },
                            ticks: {
                                callback: v => v >= 1000 ? '$'+(v/1000).toFixed(0)+'B' : '$'+v+'M'
                            }
                        }
                    }
                },
                plugins: [weekendDotsPlugin, fallbackIconPlugin]
            });

            // â”€â”€ 2. BURN CHART (standalone bar â€” always readable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            burnChartInst = new Chart(
                document.getElementById('burnChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'XRP Burned',
                        data: displayData.map(d => d.burn_xrp ?? null),
                        backgroundColor: 'rgba(214,39,40,0.7)',
                        borderColor: '#d62728',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: {
                            label: ctx => ctx.raw == null ? null
                                : `Burned: ${ctx.raw.toFixed(2)} XRP`
                        }}
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'XRP Burned' },
                            ticks: { callback: v => v + ' XRP' }
                        }
                    }
                },
                plugins: [weekendDotsPlugin]
            });

            // â”€â”€ 3. TX CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const txDatasets = catKeys.map(cat => ({
                label: catLabel(cat),
                data: displayData.map(d =>
                    hasCategories(d.tx_categories) ? (d.tx_categories[cat] || 0) : 0),
                backgroundColor: colors[cat], stack: 'Stack 0'
            }));
            txDatasets.push({
                label: 'In Progress',
                data: displayData.map(d =>
                    !hasCategories(d.tx_categories) ? (d.transactions ?? null) : 0),
                backgroundColor: colors.pending, stack: 'Stack 0'
            });

            txChartInst = new Chart(
                document.getElementById('txChart').getContext('2d'), {
                type: 'bar',
                data: { labels, datasets: txDatasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { tooltip: { callbacks: {
                        label: ctx => !ctx.raw ? null
                            : `${ctx.dataset.label}: ${Number(ctx.raw).toFixed(3)}M txs`
                    }}},
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            title: { display: true, text: 'Transactions (Millions)' }
                        }
                    }
                },
                plugins: [weekendDotsPlugin, fallbackIconPlugin]
            });
        }

        // â”€â”€ Monthly rollup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function rollUpMonthly(data) {
            const months = {};
            data.forEach(d => {
                const m = d.date.slice(0, 7);
                if (!months[m]) months[m] = { entries: [], date: m + '-01', is_fallback: false };
                months[m].entries.push(d);
                if (d.is_fallback) months[m].is_fallback = true;
            });
            return Object.values(months).map(({ entries, date, is_fallback }) => {
                const avg = key => {
                    const vals = entries.map(e => e[key]).filter(v => v != null);
                    return vals.length ? vals.reduce((a,b) => a+b, 0) / vals.length : null;
                };
                const sumCat = (field, cat) =>
                    entries.reduce((s, e) => s + ((e[field] || {})[cat] || 0), 0);
                const catKeys = ['settlement', 'identity', 'defi', 'acct_mgmt'];
                const hasCat  = entries.some(e => hasCategories(e.tx_categories));
                return {
                    date, last_updated: date, is_fallback,
                    burn_xrp:    avg('burn_xrp'),
                    load_usd_m:  avg('load_usd_m'),
                    transactions: avg('transactions'),
                    tx_categories:   hasCat ? Object.fromEntries(catKeys.map(k=>[k, sumCat('tx_categories',k)]))  : {},
                    load_categories: hasCat ? Object.fromEntries(catKeys.map(k=>[k, sumCat('load_categories',k)])) : {},
                };
            });
        }

        // â”€â”€ GitHub Actions trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function triggerUpdate() {
            const token = prompt("Enter GitHub Personal Access Token:");
            if (!token) return;
            const r = await fetch(
                `https://api.github.com/repos/pintuwang/xrpburn/actions/workflows/daily_update.yml/dispatches`,
                { method: 'POST',
                  headers: { 'Authorization': `Bearer ${token}`,
                             'Accept': 'application/vnd.github.v3+json' },
                  body: JSON.stringify({ ref: 'main' }) }
            );
            alert(r.ok
                ? "âœ… Update triggered! Check the Actions tab."
                : `âŒ Failed (${r.status}). Ensure token has 'workflow' scope.`);
        }

        window.onload = loadData;
    </script>
</body>
</html>
